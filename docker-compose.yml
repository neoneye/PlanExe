x-worker_plan_database-base: &worker_plan_database_base
  build:
    context: .
    dockerfile: worker_plan_database/Dockerfile
  depends_on:
    database_postgres:
      condition: service_healthy
  env_file:
    - .env
  environment: &worker_plan_database_env
    PLANEXE_CONFIG_PATH: /app
    PLANEXE_RUN_DIR: /app/run
    PLANEXE_WORKER_PLAN_DB_HOST: ${PLANEXE_WORKER_PLAN_DB_HOST:-database_postgres}
    PLANEXE_WORKER_PLAN_DB_PORT: ${PLANEXE_WORKER_PLAN_DB_PORT:-5432}
    PLANEXE_WORKER_PLAN_DB_NAME: ${PLANEXE_POSTGRES_DB:-planexe}
    PLANEXE_WORKER_PLAN_DB_USER: ${PLANEXE_POSTGRES_USER:-planexe}
    PLANEXE_WORKER_PLAN_DB_PASSWORD: ${PLANEXE_POSTGRES_PASSWORD:-planexe}
    PLANEXE_IFRAME_GENERATOR_CONFIRMATION_PRODUCTION_URL: ${PLANEXE_IFRAME_GENERATOR_CONFIRMATION_PRODUCTION_URL:-https://example.com/iframe_generator_confirmation}
    PLANEXE_IFRAME_GENERATOR_CONFIRMATION_DEVELOPMENT_URL: ${PLANEXE_IFRAME_GENERATOR_CONFIRMATION_DEVELOPMENT_URL:-https://example.com/iframe_generator_confirmation}
  volumes:
    - ./.env:/app/.env:ro
    - ./llm_config.json:/app/llm_config.json:ro
    - ./run:/app/run
  restart: unless-stopped

services:
  database_postgres:
    build:
      context: .
      dockerfile: database_postgres/Dockerfile
    container_name: database_postgres
    environment:
      PLANEXE_POSTGRES_USER: ${PLANEXE_POSTGRES_USER:-planexe}
      PLANEXE_POSTGRES_PASSWORD: ${PLANEXE_POSTGRES_PASSWORD:-planexe}
      PLANEXE_POSTGRES_DB: ${PLANEXE_POSTGRES_DB:-planexe}
      POSTGRES_USER: ${PLANEXE_POSTGRES_USER:-planexe}
      POSTGRES_PASSWORD: ${PLANEXE_POSTGRES_PASSWORD:-planexe}
      POSTGRES_DB: ${PLANEXE_POSTGRES_DB:-planexe}
    ports:
      - "${PLANEXE_POSTGRES_PORT:-5432}:5432"
    volumes:
      - database_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PLANEXE_POSTGRES_USER:-planexe}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  worker_plan:
    build:
      context: .
      dockerfile: worker_plan/Dockerfile
    container_name: worker_plan
    env_file:
      - .env
    environment:
      PLANEXE_CONFIG_PATH: /app
      PLANEXE_HOST_RUN_DIR: ${PLANEXE_HOST_RUN_DIR:-${PWD}/run}
      PLANEXE_RUN_DIR: /app/run
      PLANEXE_WORKER_RELAY_PROCESS_OUTPUT: "true"
    ports:
      - "8000:8000"
    volumes:
      - ./.env:/app/.env:ro
      - ./llm_config.json:/app/llm_config.json:ro
      - ./run:/app/run
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/healthz').read()"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    develop:
      watch:
        - action: sync
          path: ./worker_plan
          target: /app/worker_plan
        - action: rebuild
          path: ./worker_plan/pyproject.toml
        - action: restart
          path: ./docker-compose.yml

  worker_plan_database:
    <<: *worker_plan_database_base
    container_name: worker_plan_database

  worker_plan_database_1:
    <<: *worker_plan_database_base
    container_name: worker_plan_database_1
    environment:
      <<: *worker_plan_database_env
      PLANEXE_WORKER_ID: "1"

  worker_plan_database_2:
    <<: *worker_plan_database_base
    container_name: worker_plan_database_2
    environment:
      <<: *worker_plan_database_env
      PLANEXE_WORKER_ID: "2"

  worker_plan_database_3:
    <<: *worker_plan_database_base
    container_name: worker_plan_database_3
    environment:
      <<: *worker_plan_database_env
      PLANEXE_WORKER_ID: "3"

  frontend_single_user:
    build:
      context: .
      dockerfile: frontend_single_user/Dockerfile
    container_name: frontend_single_user
    depends_on:
      worker_plan:
        condition: service_healthy
    env_file:
      - .env
    environment:
      PLANEXE_WORKER_PLAN_URL: ${PLANEXE_WORKER_PLAN_URL:-http://worker_plan:8000}
      PLANEXE_WORKER_PLAN_TIMEOUT: ${PLANEXE_WORKER_PLAN_TIMEOUT:-30}
      PLANEXE_GRADIO_SERVER_NAME: ${PLANEXE_GRADIO_SERVER_NAME:-0.0.0.0}
      PLANEXE_GRADIO_SERVER_PORT: ${PLANEXE_GRADIO_SERVER_PORT:-7860}
      PLANEXE_PASSWORD: ${PLANEXE_PASSWORD:-}
      PLANEXE_OPEN_DIR_SERVER_URL: ${PLANEXE_OPEN_DIR_SERVER_URL:-}
    ports:
      - "7860:7860"
    volumes:
      - ./.env:/app/.env:ro
      - ./llm_config.json:/app/llm_config.json:ro
      - ./run:/app/run
    restart: unless-stopped
    develop:
      watch:
        - action: sync
          path: ./frontend_single_user
          target: /app/frontend_single_user
        - action: restart
          path: ./frontend_single_user
        - action: sync
          path: ./worker_plan
          target: /app/worker_plan
        - action: sync
          path: ./llm_config.json
          target: /app/llm_config.json
        - action: sync
          path: ./.env
          target: /app/.env
        - action: rebuild
          path: ./worker_plan/pyproject.toml
        - action: restart
          path: ./docker-compose.yml

  frontend_multi_user:
    build:
      context: .
      dockerfile: frontend_multi_user/Dockerfile
    container_name: frontend_multi_user
    depends_on:
      database_postgres:
        condition: service_healthy
      worker_plan:
        condition: service_healthy
    env_file:
      - .env
    environment:
      PLANEXE_FRONTEND_MULTIUSER_DB_HOST: ${PLANEXE_FRONTEND_MULTIUSER_DB_HOST:-database_postgres}
      PLANEXE_FRONTEND_MULTIUSER_DB_PORT: ${PLANEXE_FRONTEND_MULTIUSER_DB_PORT:-5432}
      PLANEXE_FRONTEND_MULTIUSER_DB_NAME: ${PLANEXE_POSTGRES_DB:-planexe}
      PLANEXE_FRONTEND_MULTIUSER_DB_USER: ${PLANEXE_POSTGRES_USER:-planexe}
      PLANEXE_FRONTEND_MULTIUSER_DB_PASSWORD: ${PLANEXE_POSTGRES_PASSWORD:-planexe}
      PLANEXE_FRONTEND_MULTIUSER_ADMIN_USERNAME: ${PLANEXE_FRONTEND_MULTIUSER_ADMIN_USERNAME:-admin}
      PLANEXE_FRONTEND_MULTIUSER_ADMIN_PASSWORD: ${PLANEXE_FRONTEND_MULTIUSER_ADMIN_PASSWORD:-admin}
    ports:
      - "${PLANEXE_FRONTEND_MULTIUSER_PORT:-5001}:5000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/health').read()"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped

volumes:
  database_postgres_data:
